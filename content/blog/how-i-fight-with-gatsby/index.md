---
status: private
title: Mình đã vật lộn với Gatsby như thế nào?
date: "2019-12-05T20:46:37.121Z"
---

## Mình đã chiến đầu với Gatsby ra sao :)

Không biết liệu có quá sớm để viết bài viết này hay không, nhưng vì mình muốn ghi lại những kiến thức này để mai không quên :D. Sau 1 ngày bắt tay với Gatsby vì tính nóng vội không thèm đọc kỹ documentation mà đã nhảy ngay vào thực hành khiến mình cảm thấy bối rối khi viết những dòng code. Vấn đề xảy ra là khi mình nhận thấy nếu số lượng bài viết quá lớn thì khi đó không thể đẩy tất cả các bài viết fetch từ graph vào trang index được, cần có một bước tiến mới hơn là phân trang hoặc scroll để load more. Và mình đã lựa chọn giải pháp thứ 2, khi ấy mình sử dụng package [react-infinite-scroller](http://cassetterocks.github.io/react-infinite-scroller/) để làm điều này ( thật thất bại khi không thể tự viết 1 component scoller :( ), sau khi tìm được package cần thiết thì đi đến vấn đề thứ 2 là làm sao để fetch dữ liệu mỗi lần handle scroll được đây, ngay lúc đó mình nhận ra thằng Gatsby thật quái dợ, mỗi component của không fetch trực tiếp dữ liệu ngay tại component mà sẽ thông qua GraphQL query ở pageQuery, lúc này mình mới tự nhủ "đùa ... thằng này chơi trò này thì sao gọi được dữ liệu vào handle bây giờ" ngay lập tức research để tìm cách có thể gọi động dữ liệu với GraphQL bằng api mà gatsby cung cấp nhưng bất ngờ chưa mình tìm thấy useStaticQuery hook, StaticQuery Component và static đã nói lên tất cả, không thể dynamic dữ liệu bất cứ lúc nào mình muốn đc, ơ khoan ... đến đây mình đã nhận ra vấn đề, đù mình ngáo đá thật rồi, đây là code client là lúc mà response trả về client rồi cơ mà, code này đang chạy trên client thì sao call được các hàm của Gatsby trên máy client được, đúng kiểu boy viết server nhảy qua làm việc trên client, lúc nào cũng nghĩ database, data ngay ở trên tay, muốn gọi lúc nào thì gọi :). Tự vả mình 3 cái rồi tìm xem liệu có thể khai thác con gastby để biến nó thành 1 con API để gọi dữ liệu qua HTTP được không, nhưng khoan nói về vấn đề đó, tại đây mình sẽ chỉ xoay quanh cách Gatsby hoạt động mà thôi.

Document có mục [Gatsby Internal](https://www.gatsbyjs.org/docs/gatsby-internals/) đã nói rất rõ về cơ chế hoạt đông của gatsby và mình sẽ chỉ khái quát cũng như đưa ra cái nhìn của bản thân mình đối với một static site generator.

Trước tiên cần hiểu được một **static site generator** là gì: là một công cụ tạo ra các file HTML/CSS đưa thành file public và khi client request lên server thì server chỉ việc trả lại file HTML/CSS đó vì vậy mà tốc độ request tới các static site rất là nhanh. Gatsby là một static site generator nhưng kiểu là một con lai vậy nó vừa là static vừa dynamic được (dynamic ở chỗ code js trên client có thể thay đổi content của page mà không phải tải trang khác). Vì vậy Gatsby là client-side-rendering (mình nghĩ vậy). Bởi nó trả về file HTML đã được dựng sẵn dữ liệu nên nó cũng k hẳn là server-side-rendering mặc dù server có thực hiện việc generator các file HTML đó từ data, nhưng là quá trình build chứ không phải quá trình mà server nhận request xong mới tạo file html và trả về.
Vậy quá trình build ra các file HTML là công việc chính của Gatsby còn lại thì nó như một app react bình thường. Flow của nó đơn giản sẽ như này:
Core Gatsby sẽ thông qua những khai báo trong gatsby-node.js và default là generator từ folder pages để tạo ra các file HTML bởi vậy mà mọi component muốn đc generator có dữ liệu thì phải sử dụng 1 trong 4 cách là export pageQuery trong component page, useStaticQuery hook, sử dụng StaticQuery Component và generator ngay tại file gatsby-node.js. Khi build thì Gatsby sẽ thông qua các query lấy dữ liệu sau đó đổ vào các component đó xong xuôi hết nó thu được 1 DOM tree, từ DOM tree nó sẽ hình thành file HTML, phần còn lại sẽ là các component được build lại giống hệt như một react app, phần script đó sẽ được nhúng vào các file HTML và biến nó thành một client-side-rendering chính hiệu nhưng tốc độ nhanh hơn rất nhiều vì phần dữ liệu default đều đã đc server xử lý và build ra file HTML, khi có request tới thì client sẽ nhận đc ngay file HTML đó và render ra rất nhanh chóng, thế nên tốc độ của nó rất là nhanh.

## Kết thúc
Bài viết cũng khá dài nên mình sẽ dừng ở đây thôi, trên đây chỉ là những kiến thức rất non nớt của mình sau vài ngày làm quen với gatsby vì vậy mà mình không đảm bảo chính xác 100% nhưng đó cũng là những vấn đề dễ hiểu nhất mà mình tóm gọn được, cảm ơn mọi người đã theo dõi !
